<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>Una | Live Stream</title>
		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm/css/xterm.css">
		<link rel="stylesheet" href="./style.css">
	</head>
	<body class="offline" id="body-state">

		<header>
			<div class="logo">UNA //</div>
			<div id="live-label" style="font-size: 0.7rem; background: var(--error); padding: 2px 6px; border-radius: 4px; font-weight: bold; display:none;">LIVE</div>
		</header>

		<div id="main">
			<div id="viewport">
				<div id="term-wrapper">
					<div id="term" style="height: 100%;"></div>
				</div>

				<div style="margin-top: 15px;">
					<h1 style="margin:0; font-size: 1.2rem;">Terminal Session Live by Una</h1>
					<p style="color:var(--text-muted); font-size: 0.9rem;">Real time terminal streaming platform</p>
				</div>
			</div>

			<aside id="sidebar">
				<div class="sidebar-header">Stream Chat(Placeholder to be implemented)</div>
				<div id="chat-feed">
					<div class="chat-msg"><span class="chat-user">System:</span> Waiting for host connection...</div>
				</div>

				<div class="status-area">
					<div class="indicator"></div>
					<div>
						<div id="status-text" style="font-weight: bold; font-size: 0.9rem;">OFFLINE</div>
						<div style="font-size: 0.75rem; color: var(--text-muted);">Auto-reconnecting...</div>
					</div>
				</div>
			</aside>
		</div>

		<script src="https://cdn.jsdelivr.net/npm/xterm/lib/xterm.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit/lib/xterm-addon-fit.js"></script>

		<script>
const term = new Terminal({
	cursorBlink: true,
	fontSize: 14,
	fontFamily: '"Fira Code", monospace',
	theme: {
		background: '#000000',
		foreground: '#efeff1',
		cursor: '#9147ff',
		selection: 'rgba(145, 71, 255, 0.3)'
	}
});

const fitAddon = new FitAddon.FitAddon();
term.loadAddon(fitAddon);
term.open(document.getElementById('term'));
fitAddon.fit();

const body = document.getElementById("body-state");
const statusText = document.getElementById("status-text");
const liveLabel = document.getElementById("live-label");
const chatFeed = document.getElementById("chat-feed");

function addChat(msg) {
	const div = document.createElement('div');
	div.className = 'chat-msg';
	div.innerHTML = `<span class="chat-user">System:</span> ${msg}`;
	chatFeed.appendChild(div);
	chatFeed.scrollTop = chatFeed.scrollHeight;
}

let ws;
function connectWS() {
	ws = new WebSocket("ws://localhost:8080/ws");
	ws.binaryType = "arraybuffer";

	ws.onopen = () => {
		body.className = "live";
		statusText.textContent = "LIVE";
		liveLabel.style.display = "block";
		addChat("Connected to terminal instance.");
	};

	ws.onclose = () => {
		body.className = "offline";
		statusText.textContent = "OFFLINE";
		liveLabel.style.display = "none";
		addChat("Connection lost. Retrying...");
		setTimeout(connectWS, 2000);
	};

	ws.onmessage = e => {
		try {
			const data = JSON.parse(e.data);
			if (data.type === "output") term.write(data.data);
		} catch(err) {
			// If raw data is sent instead of JSON
			term.write(e.data);
		}
	};
}

connectWS();
window.addEventListener('resize', () => fitAddon.fit());
		</script>
	</body>
</html>
